generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ========================================
// ORGANIZATIONS & USERS
// ========================================

model Organization {
  id        String   @id @default(uuid())
  name      String
  plan      String   @default("FREE") // FREE, BASIC, PREMIUM, ENTERPRISE
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users             User[]
  sites             Site[]
  resourceTemplates ResourceTemplate[]
  subscription      Subscription?

  @@map("organizations")
}

enum UserRole {
  SUPER_ADMIN
  ADMIN
  SUB_ADMIN
  SUPERVISOR
  CLIENT
}

model User {
  id             String   @id @default(uuid())
  email          String   @unique
  password       String
  name           String
  phone          String?
  role           UserRole
  faceImageUrl   String?
  is2FAEnabled   Boolean  @default(false)
  twoFASecret    String?
  isActive       Boolean  @default(true)
  organizationId String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  siteAssignments   SiteUser[]
  attendanceRecords Attendance[]
  reportsCreated    Report[]       @relation("ReportCreator")
  reportsApproved   Report[]       @relation("ReportApprover")
  comments          Comment[]
  tasksAssigned     Task[]
  documentsUploaded Document[]
  notifications     Notification[]
  auditLogs         AuditLog[]
  resourceUpdates   Resource[]

  @@index([organizationId])
  @@index([email])
  @@index([role])
  @@map("users")
}

model Subscription {
  id             String   @id @default(uuid())
  organizationId String   @unique
  plan           String // FREE, BASIC, PREMIUM, ENTERPRISE
  startDate      DateTime
  endDate        DateTime
  isActive       Boolean  @default(true)
  maxUsers       Int      @default(10)
  maxSites       Int      @default(5)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("subscriptions")
}

// ========================================
// SITES & ASSIGNMENTS
// ========================================

enum SiteStatus {
  PLANNING
  ACTIVE
  ON_HOLD
  COMPLETED
  CANCELLED
}

model Site {
  id              String     @id @default(uuid())
  name            String
  location        String
  gpsCoordinates  Json? // { latitude: number, longitude: number }
  status          SiteStatus @default(PLANNING)
  startDate       DateTime?
  expectedEndDate DateTime?
  actualEndDate   DateTime?
  organizationId  String
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  siteUsers  SiteUser[]
  resources  Resource[]
  reports    Report[]
  attendance Attendance[]
  tasks      Task[]
  documents  Document[]
  milestones Milestone[]

  @@index([organizationId])
  @@index([status])
  @@map("sites")
}

enum SiteUserRole {
  SITE_MANAGER
  SUPERVISOR
  CLIENT
  SUB_ADMIN
}

model SiteUser {
  id         String       @id @default(uuid())
  siteId     String
  userId     String
  role       SiteUserRole
  assignedAt DateTime     @default(now())

  site Site @relation(fields: [siteId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([siteId, userId])
  @@index([siteId])
  @@index([userId])
  @@map("site_users")
}

// ========================================
// ATTENDANCE
// ========================================

model Attendance {
  id          String    @id @default(uuid())
  userId      String
  siteId      String
  clockIn     DateTime
  clockOut    DateTime?
  gpsLocation Json? // { latitude: number, longitude: number, accuracy: number }
  selfieUrl   String?
  verified    Boolean   @default(false)
  hoursWorked Float?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  site Site @relation(fields: [siteId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([siteId])
  @@index([clockIn])
  @@map("attendance")
}

// ========================================
// RESOURCES
// ========================================

model ResourceTemplate {
  id             String   @id @default(uuid())
  organizationId String
  name           String
  unit           String // e.g., "kg", "liters", "pieces"
  alertThreshold Int      @default(0)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  resources    Resource[]

  @@index([organizationId])
  @@map("resource_templates")
}

model Resource {
  id          String   @id @default(uuid())
  siteId      String
  templateId  String
  quantity    Float
  lastUpdated DateTime @default(now())
  updatedBy   String

  site     Site             @relation(fields: [siteId], references: [id], onDelete: Cascade)
  template ResourceTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  updater  User             @relation(fields: [updatedBy], references: [id])

  @@unique([siteId, templateId])
  @@index([siteId])
  @@map("resources")
}

// ========================================
// REPORTS
// ========================================

enum ReportStatus {
  DRAFT
  SUBMITTED
  APPROVED
  REJECTED
}

model Report {
  id             String       @id @default(uuid())
  siteId         String
  supervisorId   String
  reportDate     DateTime
  workersPresent Int
  description    String       @db.Text
  resourcesUsed  Json? // Array of { templateId: string, quantity: number }
  status         ReportStatus @default(SUBMITTED)
  approvedBy     String?
  approvedAt     DateTime?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  site       Site  @relation(fields: [siteId], references: [id], onDelete: Cascade)
  supervisor User  @relation("ReportCreator", fields: [supervisorId], references: [id])
  approver   User? @relation("ReportApprover", fields: [approvedBy], references: [id])

  photos   ReportPhoto[]
  comments Comment[]

  @@index([siteId])
  @@index([supervisorId])
  @@index([reportDate])
  @@index([status])
  @@map("reports")
}

model ReportPhoto {
  id         String   @id @default(uuid())
  reportId   String
  url        String
  caption    String?
  uploadedAt DateTime @default(now())

  report Report @relation(fields: [reportId], references: [id], onDelete: Cascade)

  @@index([reportId])
  @@map("report_photos")
}

model Comment {
  id        String   @id @default(uuid())
  reportId  String
  userId    String
  content   String   @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  report Report @relation(fields: [reportId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([reportId])
  @@index([userId])
  @@map("comments")
}

// ========================================
// TASKS
// ========================================

enum TaskStatus {
  TODO
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

model Task {
  id          String       @id @default(uuid())
  siteId      String
  title       String
  description String?      @db.Text
  assignedTo  String?
  dueDate     DateTime?
  status      TaskStatus   @default(TODO)
  priority    TaskPriority @default(MEDIUM)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  site     Site  @relation(fields: [siteId], references: [id], onDelete: Cascade)
  assignee User? @relation(fields: [assignedTo], references: [id])

  @@index([siteId])
  @@index([assignedTo])
  @@index([status])
  @@map("tasks")
}

// ========================================
// DOCUMENTS
// ========================================

enum DocumentType {
  BOQ
  INVOICE
  DRAWING
  CONTRACT
  PHOTO
  OTHER
}

model Document {
  id           String       @id @default(uuid())
  siteId       String
  uploadedBy   String
  type         DocumentType
  fileName     String
  encryptedUrl String
  uploadedAt   DateTime     @default(now())

  site     Site @relation(fields: [siteId], references: [id], onDelete: Cascade)
  uploader User @relation(fields: [uploadedBy], references: [id])

  @@index([siteId])
  @@index([type])
  @@map("documents")
}

// ========================================
// MILESTONES
// ========================================

model Milestone {
  id              String    @id @default(uuid())
  siteId          String
  title           String
  description     String?   @db.Text
  targetDate      DateTime
  completedDate   DateTime?
  percentComplete Int       @default(0)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  site Site @relation(fields: [siteId], references: [id], onDelete: Cascade)

  @@index([siteId])
  @@map("milestones")
}

// ========================================
// NOTIFICATIONS
// ========================================

enum NotificationType {
  LOW_RESOURCE
  LATE_ATTENDANCE
  REPORT_SUBMITTED
  REPORT_APPROVED
  REPORT_REJECTED
  TASK_ASSIGNED
  TASK_DUE
  COMMENT_ADDED
  SYSTEM_ALERT
}

model Notification {
  id        String           @id @default(uuid())
  userId    String
  type      NotificationType
  message   String           @db.Text
  metadata  Json?
  read      Boolean          @default(false)
  createdAt DateTime         @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([read])
  @@index([createdAt])
  @@map("notifications")
}

// ========================================
// AUDIT LOGS
// ========================================

model AuditLog {
  id         String   @id @default(uuid())
  userId     String?
  action     String
  entityType String
  entityId   String?
  changes    Json?
  ipAddress  String?
  createdAt  DateTime @default(now())

  user User? @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([entityType])
  @@index([createdAt])
  @@map("audit_logs")
}
